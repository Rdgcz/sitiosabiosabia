<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-eval';">

  <title>Área Restrita | Sítio Sábio Sabiá</title>

  <!-- SDKs do Firebase (versão compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- ViewerJS para visualização de imagens/PDFs -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.js"></script>

  <!-- Font Awesome para ícones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Toast notifications -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

  <style>
    :root {
      /* Cores do tema */
      --laranja-ouro: #EAA731;
      --marrom-escuro: #362219;
      --terracota: #A0470D;
      --taupe: #A67958;
      --fundo: #F8F1E5;
      --branco: #FFFFFF;
      --perigo: #C62828;
      --sucesso: #2E7D32;
      --raio-borda: 8px;
      --fonte-principal: 'Merriweather', serif;
    }
    
    body {
      font-family: var(--fonte-principal);
      background-color: var(--fundo);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Cabeçalho */
    header {
      background: var(--terracota);
      color: var(--branco);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo { height: 50px; }
    
    /* Navegação */
    nav {
      background: var(--marrom-escuro);
      padding: 0.5rem;
    }
    nav ul {
      display: flex; 
      justify-content: center;
      list-style: none; 
      gap: 1rem; 
      margin: 0; 
      padding: 0;
    }
    nav a {
      color: var(--fundo);
      text-decoration: none;
      font-weight: bold;
    }
    
    /* Conteúdo principal */
    main {
      flex: 1; 
      padding: 2rem; 
      max-width: 1200px; 
      margin: 0 auto; 
      width: 100%;
    }
    .card {
      background: var(--branco);
      border-radius: var(--raio-borda);
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    /* Botões */
    .btn {
      background: var(--laranja-ouro);
      color: var(--marrom-escuro);
      border: none; 
      padding: 0.6rem 1rem;
      border-radius: 4px;
      font-weight: bold; 
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn:hover {
      background: var(--terracota); 
      color: var(--branco);
    }
    .btn-perigo { background: var(--perigo); color: var(--branco); }
    .btn-sucesso { background: var(--sucesso); color: var(--branco); }
    .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }
    
    /* Gerenciador de arquivos */
    #file-manager { 
      display: grid; 
      grid-template-columns: 250px 1fr; 
      gap: 1.5rem; 
    }
    #subpastas, #arquivos { 
      background: var(--branco); 
      padding: 1rem; 
      border-radius: var(--raio-borda); 
    }
    .folder, .file {
      padding: 0.6rem; 
      margin: 0.3rem 0; 
      cursor: pointer;
      border-radius: 4px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
    }
    .folder:hover, .file:hover { background: rgba(234,167,49,0.1); }
    
    /* Breadcrumbs */
    .breadcrumbs {
      padding: 0.5rem 0;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    .breadcrumbs span {
      cursor: pointer;
      color: var(--terracota);
    }
    .breadcrumbs span:hover {
      text-decoration: underline;
    }
    
    /* Paginação */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
    }
    
    /* Responsividade */
    @media(max-width:768px) { 
      #file-manager { grid-template-columns: 1fr; } 
    }
  </style>
</head>

<body>
  <header>
    <div>
      <img src="../assets/images/brand/logo/logo_sss_redu_compressed.png" alt="Logo Sítio Sábio Sabiá" class="logo">
    </div>
    <h1>Área Restrita</h1>
    <button id="logout-btn" class="btn btn-perigo" title="Sair da conta">
      <i class="fas fa-sign-out-alt"></i> Sair
    </button>
  </header>

  <nav>
    <ul>
      <li><a href="../index.html">Página Inicial</a></li>
      <li><a href="../cunha.html">Cunha</a></li>
      <li><a href="../galeria.html">Galeria</a></li>
      <li><a href="../contato.html">Contato</a></li>
    </ul>
  </nav>

  <main>
    <div class="card">
      <!-- Breadcrumbs -->
      <div class="breadcrumbs" id="breadcrumbs">
        <span onclick="listarArquivos('')">Home</span>
      </div>

      <!-- Painel de busca -->
      <div class="search-panel">
        <div style="display:flex;gap:1rem;">
          <input type="search" id="search-input" placeholder="Buscar por nome..." style="flex:1; padding:0.5rem;">
          <button id="advanced-search-toggle" class="btn btn-sm">
            <i class="fas fa-sliders-h"></i> Filtros
          </button>
          <button id="clear-search" class="btn btn-sm btn-perigo">
            <i class="fas fa-times"></i> Limpar
          </button>
        </div>
        
        <div id="advanced-search" style="display:none;margin-top:1rem;">
          <div class="search-filters">
            <div class="search-filter">
              <label for="search-type">Tipo</label>
              <select id="search-type">
                <option value="">Todos</option>
                <option value="image">Imagens</option>
                <option value="pdf">PDF</option>
                <option value="document">Documentos</option>
              </select>
            </div>
            <div class="search-filter">
              <label for="search-size">Tamanho</label>
              <select id="search-size">
                <option value="">Qualquer</option>
                <option value="small">Pequeno (0-1MB)</option>
                <option value="medium">Médio (1-5MB)</option>
                <option value="large">Grande (5MB+)</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Gerenciador de arquivos -->
      <div id="file-manager">
        <!-- Painel de pastas -->
        <div id="subpastas">
          <h3><i class="fas fa-folder"></i> Pastas</h3>
          <div id="folders-list">Carregando...</div>
        </div>
        
        <!-- Painel de arquivos -->
        <div id="arquivos">
          <h3><i class="fas fa-file"></i> Arquivos</h3>
          <div id="files-list">Carregando...</div>
          
          <!-- Paginação -->
          <div class="pagination" id="pagination"></div>
          
          <!-- Ações com arquivos -->
          <div class="file-actions">
            <input type="file" id="fileInput" style="display:none;" multiple>
            <button class="btn" onclick="document.getElementById('fileInput').click()">
              <i class="fas fa-upload"></i> Enviar
            </button>
            <button class="btn" onclick="criarPasta()">
              <i class="fas fa-folder-plus"></i> Nova Pasta
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>© <span id="current-year"></span> - Sítio Sábio Sabiá</footer>

  <script>
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC0O5QqfQae3K9-Ku9-tnpGS-ko82h10JI",
      authDomain: "sitio-sabio-sabia.firebaseapp.com",
      projectId: "sitio-sabio-sabia",
      storageBucket: "sitio-sabio-sabia.appspot.com",
      messagingSenderId: "789144165592",
      appId: "1:789144165592:web:0311bc2930a047cf160bad"
    };

    // Inicialização do Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const storage = firebase.storage();
    const db = firebase.firestore();

    // Configuração do Toastr
    toastr.options = {
      positionClass: "toast-top-right",
      preventDuplicates: true,
      progressBar: true,
      timeOut: 5000
    };

    // Variáveis globais
    let currentUser = null;
    let currentPath = '';
    let allFiles = [];
    let allFolders = [];
    let currentPage = 1;
    const itemsPerPage = 20;

    // Observador de autenticação
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
        document.getElementById('current-year').textContent = new Date().getFullYear();
        listarArquivos('');
        setupEvents();
        logAcesso();
      }
    });

    function setupEvents() {
      // Mostrar/ocultar filtros avançados
      document.getElementById('advanced-search-toggle').addEventListener('click', () => {
        const adv = document.getElementById('advanced-search');
        adv.style.display = adv.style.display === 'none' ? 'block' : 'none';
      });
      
      // Limpar filtros
      document.getElementById('clear-search').addEventListener('click', () => {
        document.getElementById('search-input').value = '';
        document.getElementById('search-type').value = '';
        document.getElementById('search-size').value = '';
        filterFiles();
      });
      
      // Aplicar filtros
      ['search-input','search-type','search-size'].forEach(id => {
        document.getElementById(id).addEventListener('input', filterFiles);
      });
      
      // Logout
      document.getElementById('logout-btn').addEventListener('click', () => {
        auth.signOut().then(() => {
          window.location.href = "login.html";
        });
      });
      
      // Upload de arquivos
      document.getElementById('fileInput').addEventListener('change', handleFileUpload);
    }

    async function listarArquivos(path) {
      try {
        currentPath = path;
        updateBreadcrumbs();
        
        document.getElementById('folders-list').innerHTML = '<i class="fas fa-spinner loading"></i> Carregando...';
        document.getElementById('files-list').innerHTML = '<i class="fas fa-spinner loading"></i> Carregando...';
        
        const storageRef = storage.ref(`documentos/${currentUser.uid}/${path}`);
        const result = await storageRef.listAll();
        
        // Ordena e processa os resultados
        allFolders = result.prefixes.sort((a,b) => a.name.localeCompare(b.name));
        allFiles = await Promise.all(result.items.map(async file => {
          const meta = await file.getMetadata();
          return {
            ref: file,
            name: file.name,
            size: meta.size,
            type: meta.contentType,
            timeCreated: meta.timeCreated
          };
        }));
        
        allFiles.sort((a,b) => a.name.localeCompare(b.name));
        showFolders(allFolders);
        showFiles(allFiles);
      } catch (error) {
        console.error('Erro ao listar arquivos:', error);
        toastr.error('Erro ao carregar arquivos');
      }
    }

    function updateBreadcrumbs() {
      if (!currentPath) {
        document.getElementById('breadcrumbs').innerHTML = '<span onclick="listarArquivos(\'\')">Home</span>';
        return;
      }
      
      const parts = currentPath.split('/').filter(p => p);
      let html = '<span onclick="listarArquivos(\'\')">Home</span>';
      let tempPath = '';
      
      parts.forEach((part, index) => {
        tempPath += part + '/';
        html += ` > <span onclick="listarArquivos('${currentPath}')">${part}</span>`;
      });
      
      document.getElementById('breadcrumbs').innerHTML = html;
    }

    function showFolders(folders) {
      const filtered = folders.filter(f => 
        f.name.toLowerCase().includes(document.getElementById('search-input').value.toLowerCase())
      );
      
      const html = filtered.map(f => `
        <div class="folder" onclick="listarArquivos('${currentPath}${f.name}/')">
          <div><i class="fas fa-folder"></i> ${escapeHtml(f.name)}</div>
        </div>
      `).join('');
      
      document.getElementById('folders-list').innerHTML = html || '<em>Nenhuma pasta encontrada.</em>';
    }

    function showFiles(files) {
      const filtered = filterFilesList(files);
      const paginated = paginateFiles(filtered);
      
      const html = paginated.map(file => {
        const type = getFileType(file.name);
        const size = formatFileSize(file.size);
        const date = formatDate(file.timeCreated);
        
        return `
        <div class="file" data-type="${type}" data-size="${file.size}" data-date="${file.timeCreated}">
          <div onclick="previewFile('${currentPath}${escapeHtml(file.name)}','${type}')">
            <i class="fas ${getFileIcon(file.name)}"></i> ${escapeHtml(file.name)} 
            <small>(${size}, ${date})</small>
          </div>
          <div>
            <button class="btn btn-sm" onclick="downloadFile('${currentPath}${escapeHtml(file.name)}')">
              <i class="fas fa-download"></i>
            </button>
            <button class="btn btn-sm btn-perigo" onclick="deleteFile('${currentPath}${escapeHtml(file.name)}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>`;
      }).join('');
      
      document.getElementById('files-list').innerHTML = html || '<em>Nenhum arquivo encontrado.</em>';
      updatePaginationControls(filtered.length);
    }

    function filterFilesList(files) {
      const searchText = document.getElementById('search-input').value.toLowerCase();
      const filterType = document.getElementById('search-type').value;
      const filterSize = document.getElementById('search-size').value;
      
      return files.filter(file => {
        // Filtro por texto
        if (!file.name.toLowerCase().includes(searchText)) return false;
        
        // Filtro por tipo
        if (filterType && getFileType(file.name) !== filterType) return false;
        
        // Filtro por tamanho
        if (filterSize === 'small' && file.size >= 1e6) return false;
        if (filterSize === 'medium' && (file.size < 1e6 || file.size >= 5e6)) return false;
        if (filterSize === 'large' && file.size < 5e6) return false;
        
        return true;
      });
    }

    function paginateFiles(files) {
      const start = (currentPage - 1) * itemsPerPage;
      return files.slice(start, start + itemsPerPage);
    }

    function updatePaginationControls(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const paginationDiv = document.getElementById('pagination');
      
      if (totalPages <= 1) {
        paginationDiv.innerHTML = '';
        return;
      }
      
      paginationDiv.innerHTML = `
        <button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(-1)">
          <i class="fas fa-chevron-left"></i> Anterior
        </button>
        <span>Página ${currentPage} de ${totalPages}</span>
        <button ${currentPage >= totalPages ? 'disabled' : ''} onclick="changePage(1)">
          Próxima <i class="fas fa-chevron-right"></i>
        </button>
      `;
    }

    function changePage(delta) {
      currentPage += delta;
      showFiles(allFiles);
    }

    function filterFiles() {
      currentPage = 1;
      showFolders(allFolders);
      showFiles(allFiles);
    }

    async function handleFileUpload(e) {
      const files = e.target.files;
      if (!files || files.length === 0) return;
      
      let uploadCount = 0;
      const uploadPromises = [];
      
      for (const file of files) {
        // Validações
        if (!isValidFilename(file.name)) {
          toastr.warning(`Nome inválido: "${file.name}". Use apenas letras, números e hífens.`);
          continue;
        }
        
        if (file.size > 10 * 1024 * 1024) { // 10MB
          toastr.warning(`Arquivo muito grande: "${file.name}" (máx. 10MB)`);
          continue;
        }
        
        const filePath = `documentos/${currentUser.uid}/${currentPath}${file.name.trim()}`;
        const storageRef = storage.ref(filePath);
        
        const metadata = {
          contentType: file.type,
          customMetadata: {
            originalName: file.name,
            uploadedBy: currentUser.uid,
            uploadedAt: new Date().toISOString()
          }
        };
        
        uploadPromises.push(
          storageRef.put(file, metadata)
            .then(() => {
              uploadCount++;
              toastr.success(`"${file.name}" enviado com sucesso`);
              logAcao('upload', { filename: file.name, size: file.size });
            })
            .catch(error => {
              console.error(`Erro ao enviar ${file.name}:`, error);
              toastr.error(`Falha ao enviar "${file.name}"`);
            })
        );
      }
      
      try {
        await Promise.all(uploadPromises);
        if (uploadCount > 0) {
          listarArquivos(currentPath);
        }
      } catch (error) {
        console.error('Erro no upload:', error);
      } finally {
        e.target.value = '';
      }
    }

    function criarPasta() {
      const nome = prompt('Digite o nome da nova pasta:');
      if (!nome) return;
      
      const nomeTrimmed = nome.trim();
      if (!isValidFilename(nomeTrimmed)) {
        toastr.error('Nome inválido. Use apenas letras, números e hífens.');
        return;
      }
      
      // Verifica se já existe
      if (allFolders.some(f => f.name === nomeTrimmed)) {
        toastr.error(`Já existe uma pasta com o nome "${nomeTrimmed}"`);
        return;
      }
      
      const filePath = `documentos/${currentUser.uid}/${currentPath}${nomeTrimmed}/.keep`;
      const content = `Pasta criada por ${currentUser.email} em ${new Date().toISOString()}`;
      
      storage.ref(filePath)
        .putString(content, 'raw', {
          contentType: 'text/plain',
          customMetadata: { purpose: 'folder-marker' }
        })
        .then(() => {
          toastr.success(`Pasta "${nomeTrimmed}" criada com sucesso`);
          listarArquivos(currentPath);
          logAcao('create_folder', { folderName: nomeTrimmed });
        })
        .catch(error => {
          console.error('Erro ao criar pasta:', error);
          toastr.error(`Erro ao criar pasta: ${error.message}`);
        });
    }

    function previewFile(path, type) {
      // Implementação similar à original, mas com tratamento de erros melhorado
    }

    function downloadFile(path) {
      storage.ref(`documentos/${currentUser.uid}/${path}`)
        .getDownloadURL()
        .then(url => {
          const a = document.createElement('a');
          a.href = url;
          a.download = path.split('/').pop();
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          logAcao('download', { filename: path.split('/').pop() });
        })
        .catch(error => {
          console.error('Erro ao baixar arquivo:', error);
          toastr.error('Erro ao baixar arquivo');
        });
    }

    function deleteFile(path) {
      if (!confirm(`Tem certeza que deseja excluir "${path.split('/').pop()}"?`)) return;
      
      storage.ref(`documentos/${currentUser.uid}/${path}`)
        .delete()
        .then(() => {
          toastr.success('Arquivo excluído com sucesso');
          listarArquivos(currentPath);
          logAcao('delete', { filename: path.split('/').pop() });
        })
        .catch(error => {
          console.error('Erro ao excluir arquivo:', error);
          toastr.error('Erro ao excluir arquivo');
        });
    }

    // Funções auxiliares
    function escapeHtml(text) {
      return text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function getFileType(name) {
      const ext = name.split('.').pop().toLowerCase();
      if (['jpg','jpeg','png','gif','webp'].includes(ext)) return 'image';
      if (ext === 'pdf') return 'pdf';
      if (['doc','docx','odt','rtf','txt'].includes(ext)) return 'document';
      return 'other';
    }

    function getFileIcon(name) {
      const type = getFileType(name);
      const icons = {
        image: 'fa-file-image',
        pdf: 'fa-file-pdf',
        document: 'fa-file-word',
        other: 'fa-file'
      };
      return icons[type] || 'fa-file';
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return `${bytes} B`;
      if (bytes < 1048576) return `${(bytes / 1024).toFixed(1)} KB`;
      return `${(bytes / 1048576).toFixed(1)} MB`;
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('pt-BR');
    }

    function isValidFilename(name) {
      return /^[a-zA-Z0-9\-_ .\u00C0-\u00FF]+$/.test(name);
    }

    function logAcesso() {
      db.collection('logs').add({
        userId: currentUser.uid,
        action: 'login',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        userAgent: navigator.userAgent
      });
    }

    function logAcao(action, details) {
      db.collection('logs').add({
        userId: currentUser.uid,
        action,
        details,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  </script>
</body>
</html>